name: Manual Relearn Execution

on:
  workflow_dispatch:
    inputs:
      image_count:
        description: 'Number of images to process'
        required: false
        default: '5'
        type: choice
        options:
          - '1'
          - '3'
          - '5'
          - '10'
      environment:
        description: 'Environment to run against'
        required: true
        default: 'production'
        type: choice
        options:
          - 'production'
          - 'development'

jobs:
  relearn:
    runs-on: ubuntu-latest
    name: Execute Relearn Workflow
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npm run db:generate

      - name: Run database migrations (production)
        if: ${{ github.event.inputs.environment == 'production' }}
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_DATABASE_ID: ${{ secrets.CLOUDFLARE_DATABASE_ID }}
        run: |
          echo "🗄️ Running production database migrations..."
          npx wrangler d1 execute relearn-db --remote --file=./prisma/migrations/init/migration.sql || echo "Initial migration may already exist"
          npx wrangler d1 execute relearn-db --remote --file=./prisma/migrations/add_posts/migration.sql || echo "Posts migration may already exist"

      - name: Execute Relearn Workflow
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_DATABASE_ID: ${{ secrets.CLOUDFLARE_DATABASE_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          IMAGE_COUNT: ${{ github.event.inputs.image_count }}
          NODE_ENV: ${{ github.event.inputs.environment }}
        run: |
          echo "🚀 Starting Relearn workflow..."
          echo "📊 Environment: $NODE_ENV"
          echo "🖼️ Image count: $IMAGE_COUNT"
          npm run dev

      - name: Summary
        if: always()
        run: |
          echo "## Relearn Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Count**: ${{ github.event.inputs.image_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY